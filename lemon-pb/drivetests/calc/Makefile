# The author of this program disclaims copyright.

SHELL := $(shell which bash)
CC := gcc
APP := calc

srcDir = $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
lemonpbDir = $(realpath $(srcDir)/../..)

.SUFFIXES:
.SUFFIXES: .c .h

CFLAGS := -Wall -W -O2 -s -pipe -std=c99
LFLAGS := -O2 -s -pipe

all: $(APP)

lemonpb: $(lemonpbDir)/lemonpb.c
	$(CC) -I$(lemonpbDir) -o $@ $(LFLAGS) $<

# Don't use $(APP).h as a target
# as the header file is not regenerated by
# lemon if there was no change in tokens names.
# Using $(APP).c is sufficient
# becase generating .c will always create the .h as well.
$(APP).pbi: lemonpb $(APP).y $(lemonpbDir)/lempar.pb
	./lemonpb -T$(lemonpbDir)/lempar.pb $(APP).y

$(APP): $(APP).pbi

# $(APP): $(APP).pbi $(APP).h main.pb
# 	cat main.pb >> $(APP).pbi
# 	$(CC) -I. -o $(APP) $(LFLAGS) $<

# test: $(APP)
# 	./$(APP)

clean:
	rm -f *.o
	rm -f *.out
	rm -f lemonpb
	rm -f $(APP) $(APP).pbi $(APP).h
